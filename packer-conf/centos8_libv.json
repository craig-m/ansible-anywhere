{
    "_comment_m": "CentOS 8 VM",
    "min_packer_version": "1.5.5",
    "builders": [
        {
            "type": "qemu",
            "name": "centos8-libvirt",
            "vm_name": "centos8-libvirt",
            "output_directory": "output-centos8/",
            "iso_url": "{{user `mirror`}}{{user `url`}}{{user `isofilename`}}",
            "iso_checksum": "{{user `checksum`}}",
            "iso_checksum_type": "sha256",
            "boot_wait": "5s",
            "boot_command": [ 
                "<tab>inst.stage2=hd:LABEL=CentOS-8-1-1911-x86_64-dvd inst.ks=http://{{ .HTTPIP }}:{{ .HTTPPort }}/ks.centos8.cfg<enter><wait>boot<enter>"
            ],
            "headless": true,
            "use_default_display": true,
            "vnc_port_min": 5900,
            "vnc_port_max": 5901,
            "display": "none",
            "accelerator": "kvm",
            "qemu_binary": "qemu-system-x86_64",
            "format": "qcow2",
            "disk_size": 32768,
            "disk_discard": "unmap",
            "disk_cache": "unsafe",
            "disk_compression": true,
            "disk_interface": "virtio-scsi",
            "net_device": "virtio-net",
            "cpus": 4,
            "memory": 4096,
            "qemuargs": [
                    [
                        "-drive",
                        "if=none,file=output-centos8/centos8-libvirt,id=drive0,cache=unsafe,discard=unmap,detect-zeroes=unmap,format=qcow2"
                    ]
            ],
            "http_directory": "{{user `packer_webroot`}}",
            "ssh_username": "root",
            "ssh_port": 22,
            "ssh_wait_timeout": "45m",
            "shutdown_command": "shutdown -P now"
        }
    ],
    "provisioners": [
        {
        "type": "shell",
        "execute_command": "{{.Vars}} bash '{{.Path}}'",
        "environment_vars": [
            "s_cos8vm_id={{user `pack_cos8vm_id`}}",
            "s_cos8vm_boxv={{user `box_version`}}"
        ],
        "scripts": [
            "scripts/packer/base.sh",
            "scripts/packer/update.sh",
            "scripts/packer/fin-and-cleanup.sh"
        ],
        "expect_disconnect": false
        },
        {
        "type": "shell",
        "inline": [
            "reboot now"
        ],
        "expect_disconnect": true,
        "pause_before": "5s",
        "timeout": "30s"
        },
        {
        "type": "shell",
        "execute_command": "bash '{{.Path}}'",
        "scripts": [
            "scripts/test.sh"
        ],
            "pause_before": "5s",
            "expect_disconnect": false
        }
    ],
    "post-processors": [
        {
        "type": "vagrant",
        "keep_input_artifact": true,
        "vagrantfile_template": "templates/vagrantfile.centos8.rb",
        "output": "boxes/CentOS8.{{.Provider}}.{{user `box_version`}}.box",
        "include": [
            "templates/info.json",
            "scripts/clean-vm.sh",
            "scripts/test.sh"
        ]
        },
        {
        "type": "checksum",
        "checksum_types": "sha256",
        "output": "boxes/{{.BuildName}}.{{user `box_version`}}.{{.ChecksumType}}.checksum"
        }
    ]
}

{
  "_comment_m": "CentOS 8 VM",
  "min_packer_version": "1.5.5",
  "builders": [
    {
      "type": "hyperv-iso",
      "name": "centos8-hyperv",
      "vm_name": "centos8-hv-build",
      "output_directory": "temp/output-centos8/",
      "temp_path": "temp/",
      "iso_url": "{{user `mirror`}}{{user `url`}}{{user `isofilename`}}",
      "iso_checksum": "{{user `checksum`}}",
      "iso_target_path": "./iso/{{user `isofilename`}}",
      "iso_checksum_type": "sha256",
      "ssh_username": "root",
      "ssh_port": 22,
      "ssh_timeout": "15m",
      "ssh_password": "1root2pass3word4",
      "ssh_handshake_attempts": 5,
      "http_directory": "{{user `packer_webroot`}}",
      "headless": false,
      "boot_wait": "5s",
      "boot_command": [ 
        "c setparams 'kickstart'<wait><enter>",
        "linuxefi /images/pxeboot/vmlinuz text noipv6 modprobe.blacklist=floppy inst.stage2=hd:LABEL={{user `isolable`}} inst.ks=http://{{ .HTTPIP }}:{{ .HTTPPort }}/ks.centos8.cfg<enter> initrdefi /images/pxeboot/initrd.img<wait><enter> boot<wait><enter>"
      ],
      "shutdown_command": "shutdown -P now",
      "generation": 2,
      "switch_name": "PackerSwitch",
      "memory": 4096,
      "enable_dynamic_memory": false,
      "cpus": 8,
      "disk_size": "8000",
      "guest_additions_mode": false,
      "first_boot_device": "SCSI:0:1",
      "enable_secure_boot": false,
      "secure_boot_template": "MicrosoftUEFICertificateAuthority"
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "execute_command": "{{.Vars}} bash '{{.Path}}'",
      "environment_vars": [
        "s_cos8vm_id={{user `pack_cos8vm_id`}}",
        "s_cos8vm_boxv={{user `box_version`}}"
      ],
      "scripts": [
        "scripts/packer/base.sh",
        "scripts/packer/update.sh",
        "scripts/packer/install_ansible.sh",
        "scripts/packer/cleanup.sh"
      ],
      "expect_disconnect": false
    },
    {
      "type": "shell",
      "inline": [
        "reboot now"
      ],
      "expect_disconnect": true,
      "pause_before": "5s",
      "timeout": "30s"
    },
    {
      "type": "shell",
      "execute_command": "bash '{{.Path}}'",
      "scripts": [
        "scripts/test.sh"
      ],
      "pause_before": "5s",
      "expect_disconnect": false
    }
  ],
  "post-processors": [
    {
      "type": "vagrant",
      "keep_input_artifact": true,
      "vagrantfile_template": "templates/vagrantfile.centos8.rb",
      "output": "boxes/CentOS8.{{.Provider}}.{{user `box_version`}}.box",
      "include": [
        "templates/info.json",
        "scripts/clean-vm.sh",
        "scripts/test.sh"
      ]
    },
    {
      "type": "checksum",
      "checksum_types": "sha256",
      "output": "boxes/{{.BuildName}}.{{user `box_version`}}.{{.ChecksumType}}.checksum"
    }
  ]
}
